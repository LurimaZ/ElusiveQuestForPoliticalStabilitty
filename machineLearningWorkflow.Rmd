---
title: "Machine learning workflow"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This workflow is based on the article by Gabriel Pierobon (2018. "A comprehensive Machine Learning workflow with multiple modelling using caret and caretEnsemble in R")

Gabriel Pierobon's main reference in this article is the book along with the dataset published by Brett Lanz (2015. Machine Learning with R, Packt Publishing)
Pierobon's intention in his article is to execute "a full supervised machine learning workflow" using caret and caretEnsemble packages.

## Modeling political stability  

I am applying his workflow on "modeling concrete strength" to the political stability and absence of violence/terrorism Modeling the political stability estimate (PV)

### The six phases of a machine learning workflow:

According to Pierobon, it is a good practive to split the workflow into the following six (6) phases:   

1) Setting 
2) Exploratory Data Analysis 
3) Feature of the target variable (political stability estimate in this case) 
4) Data Preparation 
5) Modelling 
6) Conclusion

Note: in practice, one may end up jumping from one phase to another, which is quite normal in any data analysis.

#### 1. Setting  

1.1 - What are we trying to predict?

We are trying to predict:

- the political stability score of countries on the scale of -3 to 2.5,
- the classification of countries in two categories: 

  - stable (with a score from 0 to 2.5) or 
  - unstable (with a score from -3 to 0),
  
- the classification of countries in four categories: 

  - highly stable (with a score from 1 to 2.5), 
  - moderately stable (with a score from 0 to .99), 
  - moderately unstable (with a score from -.99 to 0), and 
  - highly unstable (with a score from -3 to -1)


1.2 - What type of problem is it? 
- Supervised learning,
- Classification and Regression

We are dealing in this case with a multivariate supervised machine learning problem in which we have to predict a numeric outcome (thus we will use a mutliple regression technique) and a binary and multi-class outcome (thus we will use classification techniques).  

1.3 - What type of data do we have?
Our data is in “csv” format. It presents a header row with the column names. It seems to contain only numeric information.

1.4 - Load the required packages and import the data

After importing the data, we can see its dimension and structure

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(PerformanceAnalytics)
library(ggthemes)
library(corrplot)
library(car)
library(psych)
library(caret)
library(caretEnsemble)
library(doParallel)
library(Hmisc)
library(VIF)

# we are using the dataframe WGIdevRegimeType2.csv with imputation for inequality and poverty headcount

WGIdevRegimeType <- read_csv("WGIdevRegimeType.csv")
WGIdevRegimeType <- tbl_df(WGIdevRegimeType)
WGIdevRegimeType <- WGIdevRegimeType[, -1] #removing the first column
WGIdevRegimeType$date <- as.numeric(as.character(WGIdevRegimeType$date))
dim(WGIdevRegimeType)
summary(WGIdevRegimeType)
```

#### 2. Exploratory Data Analysis (EDA)

2.1 Viewing the data structure using glimpse in dplyr

```{r}
glimpse(WGIdevRegimeType)
names(WGIdevRegimeType)
```

**List of variables**

- Country Identification and Date:

  - country             
  - M49Code             
  - iso2c              
  - region              
  - subregion           
  - date  

- World Governance Indicators

  - stability          
  - stabilityDummy      
  - stabilityCategory   
  - corruptionControl 
  - governmentEffectiveness 
  - regulatoryQuality
  - ruleOfLaw  
  - voiceAndAccountability  

- Development, Inequality, and Poverty Variables

  - GNIperCapita       
  - devCategory         
  - GDPannualGrowthRate 
  - HDI                 
  - GINI               
  - povertyHeadCount    

- Polity IV Variables

  - polityScore         
  - polityCategory      
  - politicalChange    
  - democ               
  - autoc               
  - durable             
  - xrreg              
  - xrcomp              
  - xropen              
  - xconst              
  - parreg             
  - parcomp             
  - exrec               
  - exconst             
  - polcomp    
  
- FreedomHouse Variables

  - pr                  
  - cl                  
  - mean               
  - status              
  - inverse_pr          
  - inverse_cl          
  - inverse_mean      
  - politicalChangeFH 

variables to be included in the models:

myVariables <- c(region, subregion, date, stability, stabilityDummy, stabilityCategory, corruptionControl, governmentEffectiveness, regulatoryQuality, ruleOfLaw, voiceAndAccountability, GNIperCapita, devCategory, GDPannualGrowthRate, HDI, GINI, povertyHeadCount, polityScore, polityCategory,democ, autoc, durable, xrreg, xrcomp, xropen, xconst, parreg, parcomp, exrec, exconst, polcomp, statu, inverse_pr, inverse_cl, inverse_mean)     


2.2 Viewing the summary and the distibution of the target variable using summary, boxplot and histogram with base r or ggplot

```{r Table 1 - Summary Statistics, message=FALSE, warning=FALSE, paged.print=FALSE}
summary(WGIdevRegimeType$stability)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap="Fig. 1 - Summary Statistics of the Political Stability of the Whole World"}
ggplot(data = WGIdevRegimeType) +
  geom_boxplot(mapping = aes(y = stability), boundary = 0, fill = "grey", col = "black") +
  geom_hline(yintercept = 0, col = "red", size = 1)

```


```{r echo=FALSE, fig.cap="Fig. 2 - Histogram of the Political Stability of the Whole World", message=FALSE, warning=FALSE, paged.print=FALSE}
ggplot(data = WGIdevRegimeType) +
  geom_histogram(mapping = aes(x = stability), bins = 15, boundary = 0, fill = "grey", col = "black") +
  geom_vline(xintercept = mean(WGIdevRegimeType$stability), col = "blue", size = 1) +  
  geom_vline(xintercept = median(WGIdevRegimeType$stability), col = "red", size = 1) +
  annotate("text", label = "Median = -0.07755", x = 1.3, y = 310, col = "red", size = 5) +
  annotate("text", label = "Mean = -0.12948", x = - 1.3, y = 320, col = "blue", size = 5) 
  

```

Figures 1 and 2 show that the distribution of the target variable is not perfectly normal, but we can procede regardless.

2.3 Trend of the Political Stability of the Whole World since the End of the Cold War



```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Political Stability Trend: Annual Average Around the World
PoliticalStabilityTrendWorld <- WGIdevRegimeType %>%
  group_by(date) %>%
  summarise(AnnualAverage = mean(stability, na.rm=TRUE))
PoliticalStabilityTrendWorld <- tbl_df(PoliticalStabilityTrendWorld)

PoliticalStabilityTrendWorld
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.cap= "Fig. 3 - The Trend of Political Stability Score Around the World (1996-2016)"}
ggplot(data = PoliticalStabilityTrendWorld) +
  geom_line(aes(x = date, y = AnnualAverage), col = "red", size = 1) + geom_hline(yintercept = 0, col = "black", size = 1) +
  xlim(1996, 2016) + ylim(-.5, .5)
```



2.4 Comparing the summary statistics of stability around the world

```{r}

# Political Stability summary for each region

politicalStabilityByRegion <- summarise(group_by(WGIdevRegimeType, region),
          mean=mean(stability, na.rm = TRUE), sd=sd(stability, na.rm = TRUE))

politicalStabilityByRegion

# We compute the analysis of variance (ANOVA) to see if the differences of means are statistically significant
res.aov <- aov(stability ~ region, data = WGIdevRegimeType)

# Summary of the analysis of variance (ANOVA)
summary(res.aov)

# As the ANOVA test is significant, we compute Tukey HSD (Tukey Honest Significant Differences) for performing multiple pairwise-comparison between the means of groups

TukeyHSD(res.aov)

```




```{r}
ggplot(data = WGIdevRegimeType) +
  geom_boxplot(mapping = aes(y = stability), boundary = 0, fill = "grey", col = "black") +
  geom_hline(yintercept = 0, col = "red", size = 1) + 
  facet_grid(~ region)
```

 
2.6 Viewing the correlation of political stability with the other variables

We can plot the correlation between all variables and also generate a correlation matrix.

As a result of this procedure, we can drop the unnecessary variables that do not have any correlation or weak correlation with stability.

Since we have too many variables, we can view the correlation by areas or groups of variables, such as:

1) correlation with the other world governance indicators
2) correlation with the economic development indicators
3) correlation with the main Polity IV variables (polityScore, democ, autoc, durable)
4) correlation with other Polity IV variables (from xreg to polcomp)
5) correlation with Freedom House variables


```{r}
# Correlation chart between Political Stability and the other World Governance Indicators (WGI)
WGI <- select(WGIdevRegimeType, stability, corruptionControl, governmentEffectiveness, regulatoryQuality, ruleOfLaw, voiceAndAccountability)
correlationWGI <- chart.Correlation(WGI)
correlationWGI

# Correlation matrix with significance levels
correlationWGI2 <- rcorr(as.matrix(WGI))
correlationWGI2

```



```{r}
# Correlation between Political Stability and economic and social indicators

devIndicators <- select(WGIdevRegimeType, stability, GDPannualGrowthRate, GNIperCapita, HDI, GINI, povertyHeadCount)
correlationDev <- chart.Correlation(devIndicators)
correlationDev

# Correlation matrix with significance levels
correlationDev2 <- rcorr(as.matrix(devIndicators))
correlationDev2

```




```{r}
# Correlation between Political Stability and the main Polity IV indicators

polityIvIndicators1 <- select(WGIdevRegimeType, stability, polityScore, democ, autoc, durable)
correlationPolityIv1 <- chart.Correlation(polityIvIndicators1)
correlationPolityIv1

# Correlation matrix with significance levels
correlationPolityIv1 <- rcorr(as.matrix(polityIvIndicators1))
correlationPolityIv1


```



```{r}
# Correlation between Political Stability and the other Polity IV indicators

polityIvIndicators2 <- select(WGIdevRegimeType, stability, xrreg, xrcomp, xropen, xconst, parreg, parcomp, exrec, exconst, polcomp)
correlationPolityIv2 <- chart.Correlation(polityIvIndicators2)
correlationPolityIv2

# Correlation matrix with significance levels
correlationPolityIv2 <- rcorr(as.matrix(polityIvIndicators2))
correlationPolityIv2

```




```{r}
# Correlation between Political Stability and Freedom House indicators

freedomHouseIndicators <- select(WGIdevRegimeType, stability, inverse_pr, inverse_cl, inverse_mean)
correlationFreedomHouse <- chart.Correlation(freedomHouseIndicators)
correlationFreedomHouse

# Correlation matrix with significance levels
correlationFreedomHouse <- rcorr(as.matrix(freedomHouseIndicators))
correlationFreedomHouse

```


In addition to the correlation chart, we can also cross-tabulate political stability and the categorical variables, such as

- devCategory
- polityCategory
- politicalChange
- status
- politicalChangeFH


```{r}
#Crosstabulation between stability category and development category

#using World Bank data on GNI per capita and development category

stabilityAndDevCategory <- table(WGIdevRegimeType$devCategory, WGIdevRegimeType$stabilityCategory)
prop.table(stabilityAndDevCategory, 1)
#test of independence
chisq.test(stabilityAndDevCategory)
```


```{r}
#Crosstabulation between stability category and polity category / status
#using polity IV data
stabilityAndPolityCat <- table(WGIdevRegimeType$polityCategory, WGIdevRegimeType$stabilityCategory)
prop.table(stabilityAndPolityCat, 1)
#test of independence
chisq.test(stabilityAndPolityCat)

#using Freedom House data
stabilityAndPolityCatFH <- table(WGIdevRegimeType$status, WGIdevRegimeType$stabilityCategory)
prop.table(stabilityAndPolityCatFH, 1)
#test of independence
chisq.test(stabilityAndPolityCatFH)
```



```{r}
#Crosstabulation between political change and polity category / status
#using polity IV data
changeAndPolityCat <- table(WGIdevRegimeType$polityCategory, WGIdevRegimeType$politicalChange)
prop.table(changeAndPolityCat, 1)
#test of independence
chisq.test(changeAndPolityCat)

#using Freedom House data
changeAndStatus <- table(WGIdevRegimeType$status, WGIdevRegimeType$politicalChangeFH)
prop.table(changeAndStatus, 1)
#test of independence
chisq.test(changeAndStatus)

```

#### 3. DATA PREPARATION



#### 4. MODELING



#### 5. PREDICTIONS


#### 6. PERFORMANCE MEASURES


#### 6. CONCLUSION


