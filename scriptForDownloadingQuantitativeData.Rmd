---
title: "Scripts for Collecting and Cleaning the Quantitative Data"
author: "Adrien Ratsimbaharison"
date: "9/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Downloading and Cleaning the Data on World Governance Indicators (WGI) from the World Bank Website Using `webstats`


```{r warning=FALSE}
library(wbstats)
library(readr)
library(lubridate)
library(dplyr)
library(Hmisc)
library(caret)
library(kernlab)
library(stringr)
library(knitr)
library(VIM)

# As we collected the data from the World Bank, we realized that the country names and codes were not consistent throughout the database and between the World Bank and other organizations, such as the United Nations.
# Thus, in order to be consistent throughout the data collection and analysis, we need decided to adopt the World Bank country names and codes as explained in the following webpage: [API: Country Queries](https://datahelpdesk.worldbank.org/knowledgebase/articles/898590-api-country-queries)
# The file `WBCountryIso2c_Iso3c_M49Code.csv` was made by hand based on the information provided by the World Bank.

# downloading the data on World Governance Indicators
#data on stability estimate
stabilityDf <- wb(country = "countries_only", indicator = "PV.EST", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
stabilityDf <- tbl_df(stabilityDf)
stabilityDf <- select(stabilityDf, country, iso2c, date, stability = value)
head(stabilityDf)
summary(stabilityDf)

# the summary function shows that there are some outliers (stability < -2.5) in the data set. Since the authors of the WGI used the scale for -2.5 to 2.5, we considered these outliers as mistakes of data entries and we decided to reduce them to the minimum value of -.25:

# creating a dummy variable for stability category with dplyr: "1" for stable country, "0" for unstable country
stabilityDf <- mutate(stabilityDf,
                      stabilityDummy = if_else(stabilityDf$stability > 0, "1", "0"))
head(stabilityDf)
summary(stabilityDf)
table(stabilityDf$stabilityDummy)

# creating a variable with four categories of stability with dplyr
stabilityDf <- stabilityDf %>% mutate(stabilityCategory=cut(stability, breaks=c(-Inf, -1, 0, 1, Inf), labels=c("Highly Unstable","Moderately Unstable","Moderately Stable", "Highly Stable")))
head(stabilityDf)
summary(stabilityDf)
table(stabilityDf$stabilityCategory)

#data on control of corruption estimate
corruptionControlDf <- wb(country = "countries_only", indicator = "GV.CONT.CO.ES", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
corruptionControlDf <- tbl_df(corruptionControlDf)
corruptionControlDf <- select(corruptionControlDf, country, iso2c, date, corruptionControl = value)
head(corruptionControlDf)

# In order to be consistent throughout the data collection and analysis, we need to replace "Cape Verde" with"Cabo Verde"
corruptionControlDf$country <- str_replace(corruptionControlDf$country, "Cape Verde", "Cabo Verde")


#data on government effectiveness estimate
governmentEffectivenessDf <- wb(country = "countries_only", indicator = "GV.GOVT.EF.ES", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
governmentEffectivenessDf <- tbl_df(governmentEffectivenessDf)
governmentEffectivenessDf <- select(governmentEffectivenessDf, country, iso2c, date, governmentEffectiveness = value)
head(governmentEffectivenessDf)

# In order to be consistent throughout the data collection and analysis, we need to replace "Cape Verde" with"Cabo Verde"
governmentEffectivenessDf$country <- str_replace(governmentEffectivenessDf$country, "Cape Verde", "Cabo Verde")


#data on regulatory quality estimate
regulatoryQualityDf <- wb(country = "countries_only", indicator = "RQ.EST", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
regulatoryQualityDf <- tbl_df(regulatoryQualityDf)
regulatoryQualityDf <- select(regulatoryQualityDf, country, iso2c, date, regulatoryQuality = value)
head(regulatoryQualityDf)

# In order to be consistent throughout the data collection and analysis, we need to replace "Cape Verde" with"Cabo Verde"
regulatoryQualityDf$country <- str_replace(regulatoryQualityDf$country, "Cape Verde", "Cabo Verde")


#data on rule of law estimate
ruleOfLawDf <- wb(country = "countries_only", indicator = "GV.RULE.LW.ES", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
ruleOfLawDf <- tbl_df(ruleOfLawDf)
ruleOfLawDf <- select(ruleOfLawDf, country, iso2c, date, ruleOfLaw = value)
head(ruleOfLawDf)

# In order to be consistent throughout the data collection and analysis, we need to replace "Cape Verde" with"Cabo Verde"
ruleOfLawDf$country <- str_replace(ruleOfLawDf$country, "Cape Verde", "Cabo Verde")

#data on voice and accountability estimate
voiceAndAccountabilityDf <- wb(country = "countries_only", indicator = "GV.VOIC.AC.ES", 
                          startdate = 1996, enddate = 2018, POSIXct = TRUE)
voiceAndAccountabilityDf <- tbl_df(voiceAndAccountabilityDf)
voiceAndAccountabilityDf <- select(voiceAndAccountabilityDf, country, iso2c, date, voiceAndAccountability = value)
head(voiceAndAccountabilityDf)

# In order to be consistent throughout the data collection and analysis, we need to replace "Cape Verde" with"Cabo Verde"
voiceAndAccountabilityDf$country <- str_replace(voiceAndAccountabilityDf$country, "Cape Verde", "Cabo Verde")

# joining the data on WGI
WGI <- left_join(stabilityDf, corruptionControlDf, by = c("country", "iso2c", "date")) %>%
  left_join(., governmentEffectivenessDf, by = c("country", "iso2c", "date")) %>%
  left_join(., regulatoryQualityDf, by = c("country", "iso2c", "date")) %>%
  left_join(., ruleOfLawDf, by = c("country", "iso2c", "date")) %>%
  left_join(., voiceAndAccountabilityDf, by = c("country", "iso2c", "date"))
WGI <- tbl_df(WGI)
head(WGI)
summary(WGI)



# downloading the data on country code with region and subregion from a github repository maintained by Luke Duncalfe   
# at: https://github.com/lukes/ISO-3166-Countries-with-Regional-Codes/blob/master/all/all.csv
# According to the author and contributors, "These lists are the result of merging data from two sources, the Wikipedia ISO 3166-1 article for alpha and numeric country codes, and the UN Statistics site for countries' regional, and sub-regional codes. In addition to countries, it includes dependent territories."

regionSubregionDf <- read_csv("https://raw.githubusercontent.com/aratsimbaharison/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv")
regionSubregionDf <- tbl_df(regionSubregionDf)
regionSubregionDf <- select(regionSubregionDf, country = name, iso2c = `alpha-2`, iso3c = `alpha-3`, 
                            M49Code = `country-code`, region, subregion = `sub-region`)
regionSubregionDf <- na.omit(regionSubregionDf) # this will get rid of some locations that does not have codes

# In order to be consistent throughout the data collection and analysis we need to change the names of the following countries to align them with the list of countries in the World Bank dataframes.

# The following country names have been changed:

regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Bahamas", "Bahamas, The")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Bolivia (Plurinational State of)", "Bolivia")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Congo", "Congo, Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Congo (Democratic Republic of the)", "Congo, Dem. Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "CÃ´te d'Ivoire", "Cote d'Ivoire")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Egypt", "Egypt, Arab Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Gambia", "Gambia, The")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Hong Kong", "Hong Kong SAR, China")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Korea (Democratic People's Republic of)", "Korea, Dem. People's Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Korea (Republic of)", "Korea, Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Iran (Islamic Republic of)", "Iran, Islamic Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Lao People's Democratic Republic", "Lao PDR")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Macedonia (the former Yugoslav Republic of)", "Macedonia, FYR")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Kyrgyzstan", "Kyrgyz Republic")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Macao", "Macao SAR, China")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Micronesia (Federated States of)", "Micronesia, Fed. Sts")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Moldova (Republic of)", "Moldova")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Palestine, State of", "West Bank and Gaza")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Slovakia", "Slovakia Republic")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Taiwan, Province of China", "Taiwan, China")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Tanzania, United Republic of", "Tanzania")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "United States of America", "United States")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "United Kingdom of Great Britain and Northern Ireland", "United Kingdom")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Yemen", "Yemen, Rep.")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Viet Nam", "Vietnam")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Venezuela (Bolivarian Republic of)", "Venezuela")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Saint Kitts and Nevis", "St. Kitts and Nevis")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Saint Vincent and the Grenadines", "St. Vincent and the Grenadines")
regionSubregionDf$country <- replace(regionSubregionDf$country, regionSubregionDf$country == "Saint Lucia", "St. Lucia")
regionSubregionDf$iso3c <- replace(regionSubregionDf$iso3c, regionSubregionDf$iso3c == "COD", "ZAR")

# The following country names have been deleted:

regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Bonaire, Sint Eustatius and Saba",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Ãland Islands",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Anguilla",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Falkland Islands (Malvinas)",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "French Guiana",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "French Polynesia",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Gibraltar",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Guadeloupe",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Holy See",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Isle of Man",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Guernsey",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Jersey",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Martinique",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Mayotte",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Montserrat",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Northern Mariana Islands",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "RÃ©union",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Saint BarthÃ©lemy",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Saint Helena, Ascension and Tristan da Cunha",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Saint Martin (French part)",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Sint Maarten (Dutch part)",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Tokelau",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Turks and Caicos Islands",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Wallis and Futuna",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Svalbard and Jan Mayen",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "New Caledonia",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Norfolk Island",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Pitcairn",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Saint BarthÃ©lemy",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Saint Pierre and Miquelon",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Western Sahara",]
regionSubregionDf <- regionSubregionDf[! regionSubregionDf$country == "Virgin Islands (British)",]

View(regionSubregionDf)             

#joining the data on WGI with the UN classification by region and subregion
WGIbyCountryAndRegion <- left_join(WGI, regionSubregionDf, by = c("country", "iso2c"))
WGIbyCountryAndRegion <- tbl_df(WGIbyCountryAndRegion)
WGIbyCountryAndRegion$date <- as.numeric(as.character(WGIbyCountryAndRegion$date))
head(WGIbyCountryAndRegion)
names(WGIbyCountryAndRegion)
WGIbyCountryAndRegion <- select(WGIbyCountryAndRegion, country, M49Code, iso2c, iso3c, date, stability, stabilityDummy, stabilityCategory, corruptionControl, governmentEffectiveness, regulatoryQuality, ruleOfLaw, voiceAndAccountability, region, subregion)
names(WGIbyCountryAndRegion)
summary(WGIbyCountryAndRegion)

# cleaning the dataset: 
# the summary function shows that more than 80% of the data are missing in the following variables. So we decided to exclude these variables from this research project: corruptionControl, governmentEffectiveness, ruleOfLaw, voiceAndAccountability.
# here is the clean data on WGI by country and region which is available in the local repository under "WGIbyCountryAndRegion.csv"

WGIbyCountryAndRegion <- select(WGIbyCountryAndRegion, country, M49Code, iso2c, iso3c, date, stability, stabilityDummy, stabilityCategory, regulatoryQuality, region, subregion)
WGIbyCountryAndRegion <- na.omit(WGIbyCountryAndRegion)
names(WGIbyCountryAndRegion)
summary(WGIbyCountryAndRegion)

# # making the clean data on WGI available in the local repository
# WGIbyCountryAndRegion <- write.csv(WGIbyCountryAndRegion, "WGIbyCountryAndRegion.csv")
# WGIbyCountryAndRegion <- tbl_df(WGIbyCountryAndRegion)
# 

```

## Downloading and Cleaning the Data on Development, Inequality, and Poverty from the World Bank Website Using `webstats`


```{r warning=FALSE}
library(wbstats)
library(readr)
library(lubridate)
library(dplyr)
library(Hmisc)
library(caret)
library(kernlab)
library(stringr)
library(knitr)
library(tidyr)


#data on GDP growth (annual %) (NY.GDP.MKTP.KD.ZG)
GDPannualGrowthDF <- wb(country = "countries_only", indicator = "NY.GDP.MKTP.KD.ZG", 
                     startdate = 1996, enddate = 2018, POSIXct = TRUE)
GDPannualGrowthDF <- tbl_df(GDPannualGrowthDF)
GDPannualGrowthDF <- select(GDPannualGrowthDF, country, iso2c, date, GDPannualGrowthRate = value)
GDPannualGrowthDF$date <- as.numeric(as.character(GDPannualGrowthDF$date))
head(GDPannualGrowthDF)
summary(GDPannualGrowthDF)


#data on GNI per capita (constant 2010 US$) (NY.GNP.PCAP.KD)
GNIperCapitaDf <- wb(country = "countries_only", indicator = "NY.GNP.PCAP.KD", 
                     startdate = 1996, enddate = 2018, POSIXct = TRUE)
GNIperCapitaDf <- tbl_df(GNIperCapitaDf)
GNIperCapitaDf <- select(GNIperCapitaDf, country, iso2c, date, GNIperCapita = value)
GNIperCapitaDf$date <- as.numeric(as.character(GNIperCapitaDf$date))
head(GNIperCapitaDf)

# #data on human development index (UNDP.HDI.XD)
# HDIDf <- wb(country = "countries_only", indicator = "UNDP.HDI.XD", 
#             startdate = 1996, enddate = 2018, POSIXct = TRUE)
# HDIDf <- tbl_df(HDIDf)
# HDIDf <- select(HDIDf, country, iso2c, date, HDI = value)
# HDIDf$date <- as.numeric(as.character(HDIDf$date))
# head(HDIDf)
# summary(HDIDf)

# alternative dataset for HDI, downloaded directly from the UNDP Website (http://hdr.undp.org/en/data#), but it needs to be transformed and merged to World Bank data:
UNDP_HDI <- read_csv("UNDP.HDI.csv")
head(UNDP_HDI)

UNDP_HDI <- UNDP_HDI %>% 
  gather("1990",    "1991",    "1992",    "1993",    "1994",   "1995",  "1996",    "1997",    "1998",    "1999",    "2000",   "2001",    "2002",    "2003",    "2004",    "2005",    "2006",   "2007",    "2008",    "2009",    "2010",    "2011",    "2012",   "2013",    "2014",    "2015",    "2016", "2017", key = "year", value = "HDI")
summary(UNDP_HDI)

UNDP_HDI <- tbl_df(UNDP_HDI)
UNDP_HDI <- filter(UNDP_HDI, year > 1995 & year < 2017)
UNDP_HDI <- rename(UNDP_HDI, date = year)
UNDP_HDI$date <- as.numeric(as.character(UNDP_HDI$date))
UNDP_HDI2 <- arrange(UNDP_HDI, country, date)
summary(UNDP_HDI2)

unique(UNDP_HDI2$country)

#data on social inequality measured in terms of the World Bank's GINI index (SI.POV.GINI)
GINIDf <- wb(country = "countries_only", indicator = "SI.POV.GINI", 
            startdate = 1996, enddate = 2018, POSIXct = TRUE)
GINIDf <- tbl_df(GINIDf)
GINIDf <- select(GINIDf, country, iso2c, date, GINI = value)
GINIDf$date <- as.numeric(as.character(GINIDf$date))
head(GINIDf)


# data on poverty measured in terms of the World Bank's Poverty headcount ratio at $1.90 a day (2011 PPP) (% of population) (SI.POV.DDAY)

povHeadCountDF <- wb(country = "countries_only", indicator = "SI.POV.DDAY", 
            startdate = 1996, enddate = 2018, POSIXct = TRUE)
povHeadCountDF <- tbl_df(povHeadCountDF)
povHeadCountDF <- select(povHeadCountDF, country, iso2c, date, povertyHeadCount = value)
povHeadCountDF$date <- as.numeric(as.character(povHeadCountDF$date))
head(povHeadCountDF)

# joining the data on development, social inequality, and poverty: devIneqPovDF
devIneqPovDF <- full_join(GDPannualGrowthDF, GNIperCapitaDf, by = c("country", "iso2c", "date")) %>%
  full_join(., UNDP_HDI2, by = c("country", "date")) %>%
  full_join(., GINIDf, by = c("country", "iso2c", "date")) %>%
  full_join(., povHeadCountDF, by = c("country", "iso2c", "date"))
  
devIneqPovDF <- tbl_df(devIneqPovDF)
head(devIneqPovDF)
devIneqPovDF$date <- as.numeric(as.character(devIneqPovDF$date))
names(devIneqPovDF)

# # making the data on development, social inequality and poverty available in the local repository
# devIneqPovDF <- write.csv(devIneqPovDF, "devIneqPovDF.csv")
# devIneqPovDF <- tbl_df(devIneqPovDF)


# joining the data on WGI by country and region, development, social inequality, and poverty
# (WGIdevIneqPovDF)
WGIbyCountryAndRegion <- read.csv("WGIbyCountryAndRegion.csv")
WGIdevIneqPovDF <- left_join(WGIbyCountryAndRegion, devIneqPovDF, by = c("country", "iso2c", "date"))
WGIdevIneqPovDF <- tbl_df(WGIdevIneqPovDF)
WGIdevIneqPovDF$date <- as.numeric(as.character(WGIdevIneqPovDF$date))
head(WGIdevIneqPovDF)
names(WGIdevIneqPovDF)

# cleaning the dataframe WGIdevIneqPovDF
library(VIM)
summary(WGIdevIneqPovDF)

# the first step in the data cleaning is to drop the columns with too much NAs: GINI 2432 out of 3471 obs, povertyHeadCount 2404 out of 3471 obs
WGIdevIneqPovDF <- select(WGIdevIneqPovDF, country, iso2c, date, stability, stabilityDummy, stabilityCategory, regulatoryQuality, region, subregion, GDPannualGrowthRate, GNIperCapita, HDI)

# the second step is to drop the observations with missing GDPgrowthRate (136), and then missing HDI (267)
WGIdevIneqPovDF <- subset(WGIdevIneqPovDF, WGIdevIneqPovDF$GDPannualGrowthRate != "NA")
WGIdevIneqPovDF <- subset(WGIdevIneqPovDF, WGIdevIneqPovDF$HDI != "NA")
summary(WGIdevIneqPovDF)


# the last step is to imput GNI per capita using kNN (It is reasonable to consider that GNI per capita does not dramatically increase or decrease with a span of 5 years)

# clean data on WGI and development, inequality and poverty = WGIregimeTypeByRegionDF2, which is available in the local repository under "WGIdevIneqPov.csv"

WGIdevIneqPovDF2 <- kNN(WGIdevIneqPovDF, variable = "GNIperCapita", k = 5)
WGIdevIneqPovDF2 <- select(WGIdevIneqPovDF2, country, iso2c, date, stability, stabilityDummy, stabilityCategory, regulatoryQuality, region, subregion, GDPannualGrowthRate, GNIperCapita, HDI)
summary(WGIdevIneqPovDF2)

# # making the data on WGI, development, social inequality and poverty (WGIdevIneqPovDF) available in the local repository
# 
# WGIdevIneqPov <- write.csv(WGIdevIneqPovDF2, "WGIdevIneqPov.csv")
# 

```

## Downloading and Cleaning the Data on regime types from Freedom House, Polity IV and 

```{r warning= FALSE}

library(wbstats)
library(readr)
library(lubridate)
library(dplyr)
library(Hmisc)
library(caret)
library(kernlab)
library(stringr)
library(knitr)

# # data on political system, revised combined polity score (UPP.REV.POL.XQ) - see Polity IV
# polityScoreDf <- wb(country = "countries_only", indicator = "UPP.REV.POL.XQ", 
#                     startdate = 1996, enddate = 2018, POSIXct = TRUE)
# polityScoreDf <- tbl_df(polityScoreDf)
# polityScoreDf <- select(polityScoreDf, country, iso2c, date, value)
# polityScoreDf <- rename(polityScoreDf, polityScore = value)
# polityScoreDf$date <- as.numeric(as.character(polityScoreDf$date))
# head(polityScoreDf)

# alternative dataset is Polity IV which can be directly downloaded from the Center for Systemic Peace website at: http://www.systemicpeace.org/inscrdata.html

library(readxl)
url <- "http://www.systemicpeace.org/inscr/p4v2017.xls"
destfile <- "p4v2017.xls"
curl::curl_download(url, destfile)
polityIV2017 <- read_excel(destfile)
head(polityIV2017)
names(polityIV2017)

# manipulating the data: selecting the variables of interest and filtering the years under consideration
polityIV2017 <- polityIV2017 %>%
  select("country",  "year", "democ", "autoc", "polity2", "durable", "xrreg", "xrcomp", "xropen", "xconst", "parreg", "parcomp", "exrec", "exconst", "polcomp", "prior", "emonth", "eday", "eyear", "eprec", "interim", "bmonth", "bday", "byear", "bprec", "post", "change", "d4", "sf", "regtrans") %>%
  filter(year > 1995)

polityScoreDf <- polityIV2017
polityScoreDf <- tbl_df((polityScoreDf))
polityScoreDf <- rename(polityScoreDf, polityScore = polity2, date = year)
polityScoreDf$date <- as.numeric(as.character(polityScoreDf$date))

# creating a new variable for polity category (polityCategory)
polityScoreDf <- polityScoreDf %>% mutate(polityCategory=cut(polityScore, breaks=c(-Inf, -6, 6, Inf), labels=c("Autocracy","Anocracy","Democracy")))
head(polityScoreDf)

# creating a new variable for politicalChange: either "democratization" if the polityScore increases from year1 to year1 + 1, "autocratization" if the polityScore decreases, or "no change" if the polityScore stays the same from year1 to year1 + 1.

polityScoreDf <- polityScoreDf %>% 
  group_by(country) %>% 
  mutate(politicalChange = case_when(polityScore > lag(polityScore) ~ "democratization", 
                                     polityScore < lag(polityScore) ~ "autocratization",
                                     TRUE ~ "no change"))
head(polityScoreDf)

# In order to be consistent throughout the data collection and analysis we need to change the names of the following countries to align them with the list of countries in the World Bank dataframes.

# The following country names have been changed:

polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Sudan-North", "Sudan")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Ivory Coast", "Cote d'Ivoire")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Cote D'Ivoire", "Cote d'Ivoire")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Gambia", "Gambia, The")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Cape Verde", "Cabo Verde")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Congo Brazzaville", "Congo, Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Congo Kinshasa", "Congo, Dem. Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Egypt", "Egypt, Arab Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Syria", "Syrian Arab Republic")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Iran", "Iran, Islamic Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Kyrgyzstan", "Kyrgyz Republic")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Korea North", "Korea, Dem. People's Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Russia", "Russian Federation")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Korea South", "Korea, Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "UAE", "United Arab Emirates")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Yemen", "Yemen, Rep.")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Taiwan", "Taiwan, China")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "East Timor", "Timor-Leste")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Timor Leste", "Timor-Leste")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Myanmar (Burma)", "Myanmar")
polityScoreDf$country <- replace(polityScoreDf$country, polityScoreDf$country == "Taiwan", "Taiwan, China")

# The following country names have been deleted:

polityScoreDf <- polityScoreDf[! polityScoreDf$country == "Yugoslavia",]
polityScoreDf <- polityScoreDf[! polityScoreDf$country == "Serbia and Montenegro",]
polityScoreDf <- polityScoreDf[! polityScoreDf$country == "Czechoslovakia",]

head(polityScoreDf)
names(polityScoreDf)

# joining the Freedom House data with the data on region and subregion with iso2c

polityScoreByRegionDF <- left_join(polityScoreDf, regionSubregionDf, by = "country")
polityScoreByRegionDF <- tbl_df(polityScoreByRegionDF)
names(polityScoreByRegionDF)

polityScoreByRegionDF <- select(polityScoreByRegionDF, country, date, democ, autoc, polityScore, durable, xrreg, xrcomp, xropen, xconst, parreg, parcomp, exrec, exconst, polcomp, prior, emonth, eday, eyear, eprec, interim, bmonth, bday, byear, bprec, post, change, d4, sf, regtrans, polityCategory, politicalChange, region, subregion)

head(polityScoreByRegionDF)
names(polityScoreByRegionDF)



# downloadong the "Stata Friendly Freedom House Data, 1973-2018" on political right and civil liberty maintained by Amanda B. Edgell, University of Florida (homepage: https://acrowinghen.com/data/)
 
library(readxl)
url <- "https://acrowinghen.files.wordpress.com/2018/05/fh_rankings_1973_2018.xlsx"
destfile <- "fh_rankings_1973_2018.xlsx"
curl::curl_download(url, destfile)
fh_rankings_1973_2018 <- read_excel(destfile, sheet = 3)
freedomHouseDF <- read_excel("fh_rankings_1973_2018.xlsx", sheet = 3)
freedomHouseDF <- tbl_df(freedomHouseDF)
head(freedomHouseDF)
names(freedomHouseDF)

freedomHouseDF <- select(freedomHouseDF, country, year, pr, cl, mean, status, inverse_pr, inverse_cl, inverse_mean, sum)
freedomHouseDF <- filter(freedomHouseDF, year>= 1996)
freedomHouseDF <- rename(freedomHouseDF, date = year)
freedomHouseDF$date <- as.numeric(as.character(freedomHouseDF$date))
head(freedomHouseDF)


# In order to be consistent throughout the data collection and analysis we need to change the names of the following countries to align them with the list of countries in the World Bank dataframes.

# The following country names have been changed:

freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Bahamas", "Bahamas, The")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Brunei", "Brunei Darussalam")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Cape Verde", "Cabo Verde")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Congo (Brazzaville)", "Congo, Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Congo (Kinshasa)", "Congo, Dem. Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Egypt", "Egypt, Arab Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Iran", "Iran, Islamic Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Kyrgyzstan", "Kyrgyz Republic")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Lao", "Lao PDR")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Macedonia", "Macedonia, FYR")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Micronesia", "Micronesia, Fed. Sts")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "North Korea", "Korea, Dem. People's Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Russia", "Russian Federation")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Slovakia", "Slovak Republic")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "South Korea", "Korea, Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Syria", "Syrian Arab Republic")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Yemen", "Yemen, Rep.")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Taiwan", "Taiwan, China")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Trinidad & Tobago", "Trinidad and Tobago")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Saint Vincent & Grenadines", "St. Vincent and Grenadines")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Antigua & Barbuda", "Antigua and Barbuda")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Saint Kitts and Nevis", "St. Kitts and Nevis")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Sao Tome & Principe", "Sao Tome and Principe")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Saint Lucia", "St. Lucia")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "Bosnia-Herzegovina", "Bosnia and Herzegovina")
freedomHouseDF$country <- replace(freedomHouseDF$country, freedomHouseDF$country == "East Timor", "Timor-Leste")



# The following country names have been deleted:

freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Germany, W.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Germany, E.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Czechoslovakia",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Yugoslavia (Serbia & Montenegro)",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "USSR",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Yemen, N.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Yemen, S.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Vietnam, N.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Vietnam, S.",]
freedomHouseDF <- freedomHouseDF[! freedomHouseDF$country == "Northern Cyprus",]


# The country status have been spelled out as follows: "F" = "Free", "PF" = "Partly Free", "NF" = "Not Free"

freedomHouseDF$status <- replace(freedomHouseDF$status, freedomHouseDF$status == "F", "Free")
freedomHouseDF$status <- replace(freedomHouseDF$status, freedomHouseDF$status == "PF", "Partly Free")
freedomHouseDF$status <- replace(freedomHouseDF$status, freedomHouseDF$status == "NF", "Not Free")

head(freedomHouseDF)
freedomHouseDF <- tbl_df(freedomHouseDF)


# joining the Freedom House data with the data on region and subregion with iso2c

freedomHouseByRegionDF <- left_join(freedomHouseDF, regionSubregionDf, by = "country")
freedomHouseByRegionDF <- tbl_df(freedomHouseByRegionDF)
names(freedomHouseByRegionDF)
freedomHouseByRegionDF <- select(freedomHouseByRegionDF, country, iso2c, iso3c, M49Code, date, pr, cl, sum, mean, status, inverse_pr, inverse_cl, inverse_mean, region, subregion)
head(freedomHouseByRegionDF)
str(freedomHouseByRegionDF)

# creating a new variable for politicalChangeFH: either "democratization" if the inverse_mean increases from year1 to year1 + 1, "autocratization" if the inverse_mean decreases, or "no change" if the inverse_mean stays the same from year1 to year1 + 1.

freedomHouseByRegionDF <- freedomHouseByRegionDF %>% 
  group_by(country) %>% 
  mutate(politicalChangeFH = case_when(inverse_mean > lag(inverse_mean) ~ "democratization", 
                                     inverse_mean < lag(inverse_mean) ~ "autocratization",
                                     TRUE ~ "no change"))
head(freedomHouseByRegionDF)


#joining the data on political stability and regime types indicators (regimeTypeDf)
WGIregimeTypeByRegionDF <- left_join(WGIbyCountryAndRegion, polityScoreByRegionDF, by = c("country", "date")) %>%
  left_join(., freedomHouseByRegionDF, by = c("country", "date"))

WGIregimeTypeByRegionDF <- tbl_df(WGIregimeTypeByRegionDF)

WGIregimeTypeByRegionDF <- select(WGIregimeTypeByRegionDF, country, M49Code = M49Code.x, iso3c = iso3c.x, date, stability, stabilityDummy, stabilityCategory, regulatoryQuality, polityScore, polityCategory, polityCategory,  politicalChange, democ, autoc, durable,  xrreg, xrcomp, xropen, xconst, parreg, parcomp, exrec, exconst, polcomp, pr, cl, sum, mean, status, inverse_pr, inverse_cl, inverse_mean, politicalChangeFH, region = region.x, subregion = subregion.x)

head(WGIregimeTypeByRegionDF)
names(WGIregimeTypeByRegionDF)
str(WGIregimeTypeByRegionDF)
summary(WGIregimeTypeByRegionDF)

# clean data on regime type

# step 1: remove 210 rows with NAs for Freedom House data
WGIregimeTypeByRegionDF <- WGIregimeTypeByRegionDF %>%
  filter(pr != "NA")

# Step 2: remove 456 rows with NAs for polity IV data
WGIregimeTypeByRegionDF <- WGIregimeTypeByRegionDF %>%
  filter(polityScore != "NA")

# clean WGIregimeTypeByRegionDF = WGIregimeTypeByRegionDF2 which is available in the local repository under "WGIregimeTypeByRegion.csv"

WGIregimeTypeByRegionDF2 <- WGIregimeTypeByRegionDF
head(WGIregimeTypeByRegionDF2)
summary(WGIregimeTypeByRegionDF2)

# # making the data on regime type available in the local repository
# 
# WGIregimeTypeByRegion <- write.csv(WGIregimeTypeByRegionDF2, "WGIregimeTypeByRegion.csv")


```

## Joining all dataframes on WGI, econimic and social indicators and regime types


```{r echo=TRUE, message=FALSE, warning=FALSE}
library(wbstats)
library(readr)
library(lubridate)
library(dplyr)
library(Hmisc)
library(caret)
library(kernlab)
library(stringr)
library(knitr)

# reading the clean data on WGI: "WGIbyCountryAndRegion.csv" 
WGIbyCountryAndRegion <- read_csv("WGIbyCountryAndRegion.csv")
head(WGIbyCountryAndRegion)
summary(WGIbyCountryAndRegion)

# reading the clean data on economic and social indicators: "WGIdevIneqPov.csv"
WGIdevIneqPov <- read_csv("WGIdevIneqPov.csv")
head(WGIdevIneqPov)
summary(WGIdevIneqPov)

# reading the clean data on regime type WGIregimeTypeByRegion: "WGIregimeTypeByRegion.csv"
WGIregimeTypeByRegion <- read_csv("WGIregimeTypeByRegion.csv")
head(WGIregimeTypeByRegion)
summary(WGIregimeTypeByRegion)

# joining WGI with devIneqPov and regimeType:
WGIdevRegimeType <- left_join(WGIbyCountryAndRegion, WGIdevIneqPov, by = c("country", "date")) %>%
  left_join(., WGIregimeTypeByRegion, by = c("country", "date"))

WGIdevRegimeType <- select(WGIdevRegimeType, country, date, stability, stabilityDummy, stabilityCategory, regulatoryQuality, GDPannualGrowthRate, GNIperCapita, HDI, polityScore, polityCategory, politicalChange, democ, autoc, durable, xrreg, xrcomp, xropen, xconst, parreg, parcomp, exrec, exconst, polcomp, pr, cl, mean, status, inverse_pr, inverse_cl, inverse_mean, politicalChangeFH, region, subregion)

# clean the complete dataset

# step 1: remove 403 rows with NAs for GNI per capita and HDI
WGIdevRegimeType <- WGIdevRegimeType %>%
  filter(GNIperCapita != "NA")

# Step 2: remove 422 rows with NAs for polity IV and Freedom House data
WGIdevRegimeType <- WGIdevRegimeType %>%
  filter(polityScore != "NA")

head(WGIdevRegimeType)
names(WGIdevRegimeType)
summary(WGIdevRegimeType)

# # clean WGIdevRegimeType is available in the local repository under "WGIdevRegimeType.csv"
# 
# WGIdevRegimeType <- write.csv(WGIdevRegimeType, "WGIdevRegimeType.csv")
# 


```

